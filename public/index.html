<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>S0LACE</title>

<link rel="shortcut icon" href="favicon.ico" />
<link rel="stylesheet" href="index.css" />

<script src="/scram/scramjet.all.js"></script>
<script src="register-sw.js" defer></script>
<script src="global-hub.js" defer></script>

<style>
body{min-height:100vh; margin:0; font-family: sans-serif; background: #000;}
main{min-height:100vh;display:flex;justify-content:center;align-items:center}

body.sj-proxied iframe,
body.sj-proxied .scramjet-frame{
  position:fixed;inset:0;width:100vw;height:100vh;border:none;z-index:1
}

.home-wrap{max-width:720px;width:100%;padding:32px;text-align:center}
.home-title{font-size:64px;font-weight:800;color:var(--fg, #fff)}
.home-version{margin-top:14px;font-size:11px;font-family:"Press Start 2P";color:var(--fg-dim, #888)}

.home-status{
  margin-top:16px;
  font-family:"Press Start 2P";
  font-size:10px;
  display:flex;
  justify-content:center;
  gap:10px;
  color:var(--fg-dim, #888)
}

#clock{color:var(--fg, #fff)}
#battery{color:var(--accent, #00ffcc)}

.proxy-wrap{margin-top:28px}

#sj-address{
  width:100%;
  padding:18px 22px;
  font-size:16px;
  border-radius:16px;
  background:rgba(255,255,255,.03);
  color:var(--fg, #fff);
  border:2px solid color-mix(in srgb, var(--accent, #00ffcc) 55%, transparent);
  outline:none;
  box-sizing: border-box;
}

.visitor-meta{
  margin-top:36px;
  display:flex;
  justify-content:center;
  gap:28px;
  font-family:"Press Start 2P";
  font-size:10px;
  color:var(--fg-dim, #888)
}
.visitor-meta span{color:var(--accent, #00ffcc)}
</style>
</head>

<body>

<nav class="side-header">
  <a href="index.html" class="side-icon" data-icon="home"><img></a>
  <a href="games.html" class="side-icon" data-icon="games"><img></a>
  <a href="media.html" class="side-icon" data-icon="media"><img></a>
  <a href="settings.html" class="side-icon" data-icon="settings"><img></a>
</nav>

<main>
<div class="home-wrap">

<div class="home-title">S0LACE</div>
<div class="home-version">v1.2.0</div>

<div class="home-status">
  <span id="clock">--:--</span>
  <span>•</span>
  <span id="battery">--%</span>
</div>

<div class="proxy-wrap">
<form id="sj-form">
  <input type="hidden" id="sj-search-engine" value="https://www.google.com/search?q=%s">
  <input id="sj-address" placeholder="Enter a URL or search Google" autocomplete="off">
</form>
</div>

<div class="visitor-meta">
  <div>TODAY <span id="vis-today">—</span></div>
  <div>WEEK <span id="vis-week">—</span></div>
  <div>ALL <span id="vis-all">—</span></div>
</div>

</div>
</main>

<script>
// UI/Icons Logic
function getAccent(){return localStorage.getItem("s0laceAccent")||"gray"}
function updateIcons(){
  document.querySelectorAll(".side-icon").forEach(a=>{
    const img=a.querySelector("img")
    const icon=a.dataset.icon
    const active=a.getAttribute('href') === window.location.pathname.split('/').pop()
    img.src=`thumbs/${icon}/${active?getAccent():"gray"}.png`
  })
}
updateIcons();
window.addEventListener("storage",updateIcons);

// Clock + Battery Logic
function updateClock(){
  const d=new Date()
  let h=d.getHours(), m=String(d.getMinutes()).padStart(2,"0")
  const ap=h>=12?"PM":"AM"; h=h%12||12
  document.getElementById("clock").textContent=`${h}:${m} ${ap}`
}
updateClock(); setInterval(updateClock,1000);

if(navigator.getBattery){
  navigator.getBattery().then(b=>{
    const u=()=>document.getElementById("battery").textContent=Math.round(b.level*100)+"%"
    u(); b.onlevelchange=u; b.onchargingchange=u
  })
} else document.getElementById("battery").textContent="N/A";

// FIXED PROXY HANDLER
document.getElementById("sj-form").addEventListener("submit", e => {
  e.preventDefault();
  const addressField = document.getElementById("sj-address");
  const engineField = document.getElementById("sj-search-engine");
  
  const input = addressField.value.trim();
  if(!input) return;

  const engine = engineField.value;
  const url = /^https?:\/\//i.test(input) 
    ? input 
    : engine.replace("%s", encodeURIComponent(input));

  // Ensure scramjet library is loaded before calling
  if (typeof scramjet !== 'undefined') {
    scramjet.open(url);
  } else {
    alert("Scramjet is still loading or failed to initialize.");
  }
});
</script>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"
import { getDatabase, ref, get, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"

const cfg = {
  apiKey: "AIzaSyBbgy76ThxHaKlOhpiLQ6Nw4ekR1b9t3DA",
  databaseURL: "https://s0lace-web-default-rtdb.firebaseio.com",
  projectId: "s0lace-web"
}

const app = getApps().length ? getApps()[0] : initializeApp(cfg);
const db = getDatabase(app);

const today = () => new Date().toISOString().split("T")[0];
const week = () => {
  const d = new Date(), j = new Date(d.getFullYear(), 0, 1);
  return "week_" + Math.ceil((((d - j) / 86400000) + j.getDay() + 1) / 7);
}

if(!sessionStorage.getItem("s0lace-counted")){
  sessionStorage.setItem("s0lace-counted", "1");
  runTransaction(ref(db, "visitors/all"), v => (v || 0) + 1);
  runTransaction(ref(db, "visitors/today/" + today()), v => (v || 0) + 1);
  runTransaction(ref(db, "visitors/week/" + week()), v => (v || 0) + 1);
}

const updateCounts = async () => {
  const [a, t, w] = await Promise.all([
    get(ref(db, "visitors/all")),
    get(ref(db, "visitors/today/" + today())),
    get(ref(db, "visitors/week/" + week()))
  ]);
  document.getElementById("vis-all").textContent = a.val() || 0;
  document.getElementById("vis-today").textContent = t.val() || 0;
  document.getElementById("vis-week").textContent = w.val() || 0;
}
updateCounts();
</script>

</body>
</html>
