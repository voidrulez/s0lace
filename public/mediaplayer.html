<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
    <title>S0LACE • Media Player</title>

    <link rel="shortcut icon" content="favicon.ico" />
    <link rel="stylesheet" href="index.css" />

    <script src="baremux/index.js"></script>
    <script src="epoxy/index.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8373843490344171"
     crossorigin="anonymous"></script>

    <script src="global-hub.js" defer></script>

    <style>
      body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        background-color: #0f0f0f;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .player-main {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100%;
      }

      /* Rounded Iframe Container */
      .player-frame-wrap {
        position: relative;
        flex: 1;
        margin: 15px 15px 5px 15px; /* Spacing for the rounded look */
        border-radius: 20px; 
        overflow: hidden;
        background: #000;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      }

      #media-frame {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
      }

      /* Control Area below the player */
      .player-controls {
        height: 70px;
        display: flex;
        align-items: center;
        padding: 0 30px;
      }

      /* Rounded Icon Button - Bottom Left */
      #reload-btn {
        background: rgba(255, 255, 255, 0.08);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.15);
        width: 48px;
        height: 48px;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #reload-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
      }

      /* Loading Overlay */
      .player-loading {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        font-size: 11px;
        color: #888;
        background: #000;
        z-index: 2;
        text-align: center;
        padding: 16px;
      }

      /* Hide the original info/buttons bar */
      .player-info { display: none; }
      
      .no-src {
        color: white;
        text-align: center;
        padding-top: 50px;
      }
    </style>
  </head>

  <body>
    <nav class="side-header">
      <a href="index.html" class="side-icon" data-icon="home"><img></a>
      <a href="games.html" class="side-icon" data-icon="games"><img></a>
      <a href="media.html" class="side-icon" data-icon="media"><img></a>
      <a href="ai.html" class="side-icon" data-icon="ai">
  <img />
</a>

      <a href="settings.html" class="side-icon" data-icon="settings"><img></a>
    </nav>

    <main class="player-main">
      <div class="player-frame-wrap">
        <div id="player-loading" class="player-loading">
          CONNECTING TO PROXY…
          <span id="player-loading-sub" style="margin-top: 8px; opacity: 0.6;">
            Please wait while the media prepares.
          </span>
        </div>

        <iframe
          id="media-frame"
          src="about:blank"
          allowfullscreen
          allow="fullscreen; picture-in-picture; encrypted-media"
        ></iframe>
      </div>

      <div class="player-controls">
        <button id="reload-btn" title="Reload Media">↻</button>
      </div>

      <div id="player-error" class="no-src" style="display:none;">
        No media URL provided.
      </div>
    </main>

    <script>
      // Side Icon Logic
      function getAccent() { return localStorage.getItem("s0laceAccent") || "gray"; }
      function updateSideIcons() {
        const accent = getAccent();
        document.querySelectorAll(".side-icon").forEach(link => {
          const icon = link.dataset.icon;
          const img = link.querySelector("img");
          const isActive = location.pathname.endsWith(link.getAttribute("href"));
          link.classList.toggle("active", isActive);
          img.src = `thumbs/${icon}/${isActive ? accent : "gray"}.png`;
        });
      }
      updateSideIcons();
      window.addEventListener("storage", updateSideIcons);
    </script>

    <script>
      (async () => {
        const params = new URLSearchParams(window.location.search);
        const src = params.get("src");

        const frame = document.getElementById("media-frame");
        const errorEl = document.getElementById("player-error");
        const frameWrap = document.querySelector(".player-frame-wrap");
        const loadingEl = document.getElementById("player-loading");
        const loadingSub = document.getElementById("player-loading-sub");
        const reloadBtn = document.getElementById("reload-btn");

        if (!src) {
          if (frameWrap) frameWrap.style.display = "none";
          if (errorEl) errorEl.style.display = "block";
          return;
        }

        // Reload function
        reloadBtn.addEventListener("click", () => {
          loadingEl.style.display = "flex";
          frame.src = src;
        });

        /* -------------------------------------------
           BAREMUX INIT
        -------------------------------------------- */
        try {
          const connection = new BareMux.BareMuxConnection("/baremux/worker.js");
          const wispUrl = (location.protocol === "https:" ? "wss" : "ws") + "://" + location.host + "/wisp/";

          if ((await connection.getTransport()) !== "/epoxy/index.mjs") {
            await connection.setTransport("/epoxy/index.mjs", [{ wisp: wispUrl }]);
          }
        } catch (err) {
          console.error("BareMux Error", err);
          if (loadingSub) loadingSub.textContent = "Proxy transport failed.";
        }

        /* -------------------------------------------
           LOAD IFRAME
        -------------------------------------------- */
        if (frame) {
          frame.addEventListener("load", () => {
            if (loadingEl) loadingEl.style.display = "none";
          });
          frame.src = src;
        }
      })();
    </script>

    <script>
/* === MEDIA STABILITY FIX === */

// Remove service workers (they break proxy streams)
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.getRegistrations?.().then(r =>
    r.forEach(reg => reg.unregister())
  );
  Object.defineProperty(navigator, "serviceWorker", {
    value: undefined
  });
}

// Safe URL guard
const _URL = window.URL;
window.URL = function(u, b) {
  try { return new _URL(u, b); }
  catch { return new _URL(location.href); }
};
window.URL.prototype = _URL.prototype;
</script>

  </body>
</html>
