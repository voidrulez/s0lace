<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, shrink-to-fit=no"
    />
    <title>S0LACE • Media Player</title>

    <link rel="shortcut icon" content="favicon.ico" />
    <link rel="stylesheet" href="index.css" />

    <!-- BareMux + Epoxy for Scramjet backend -->
    <script src="baremux/index.js"></script>
    <script src="epoxy/index.js"></script>

    <!-- Service worker + global stuff -->
    <script src="register-sw.js" defer></script>
    <script src="global-hub.js" defer></script>

    <style>
      .player-loading {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        font-size: 9px;
        color: var(--fg-dim);
        background: radial-gradient(
          circle at top,
          rgba(0, 0, 0, 0.95),
          rgba(0, 0, 0, 0.98)
        );
        z-index: 2;
        text-align: center;
        padding: 16px;
      }
      .player-loading span {
        margin-top: 6px;
        opacity: 0.7;
      }
      .player-frame-wrap {
        position: relative;
      }
    </style>
  </head>

  <nav class="side-header">
  <a href="index.html" class="side-icon" data-icon="home">
    <img />
  </a>

  <a href="games.html" class="side-icon" data-icon="games">
    <img />
  </a>

  <a href="media.html" class="side-icon" data-icon="media">
    <img />
  </a>

  <a href="settings.html" class="side-icon" data-icon="settings">
    <img />
  </a>
</nav>


    <main class="player-main">
      <div class="player-info">
        <div class="player-left">
          <span id="player-title">Loading…</span>
        </div>
        <div class="player-actions">
          <a href="media.html">← BACK TO MEDIA</a>
          <button id="open-new-tab">OPEN IN NEW TAB</button>
        </div>
      </div>

      <div class="player-frame-wrap">
        <div id="player-loading" class="player-loading">
          CONNECTING TO PROXY…
          <span id="player-loading-sub">
            If this takes more than a few seconds, the media host or proxy might be slow.
          </span>
        </div>

        <iframe
          id="media-frame"
          src="about:blank"
          allowfullscreen
          allow="fullscreen; picture-in-picture; encrypted-media"
        ></iframe>
      </div>

      <div id="player-error" class="no-src" style="display:none;">
        No media URL provided.
      </div>
    </main>

  <script>
function getAccent() {
  return localStorage.getItem("s0laceAccent") || "gray";
}

function updateSideIcons() {
  const accent = getAccent();

  document.querySelectorAll(".side-icon").forEach(link => {
    const icon = link.dataset.icon;
    const img = link.querySelector("img");

    const isActive =
      location.pathname.endsWith(link.getAttribute("href"));

    link.classList.toggle("active", isActive);

    img.src = `thumbs/${icon}/${isActive ? accent : "gray"}.png`;
  });
}

updateSideIcons();

// Update when accent color changes
window.addEventListener("storage", updateSideIcons);
</script>


    <script>
      (async () => {
        const params = new URLSearchParams(window.location.search);
        const src = params.get("src");
        const title = params.get("title") || "Untitled";

        const frame = document.getElementById("media-frame");
        const titleEl = document.getElementById("player-title");
        const errorEl = document.getElementById("player-error");
        const frameWrap = document.querySelector(".player-frame-wrap");
        const openNewTabBtn = document.getElementById("open-new-tab");
        const loadingEl = document.getElementById("player-loading");
        const loadingSub = document.getElementById("player-loading-sub");

        if (titleEl) titleEl.textContent = title;

        if (!src) {
          if (frameWrap) frameWrap.style.display = "none";
          if (errorEl) {
            errorEl.style.display = "flex";
            errorEl.textContent = "No media URL provided.";
          }
          return;
        }

        /* -------------------------------------------
           NEW TAB BUTTON — convert proxied URL -> direct VidFast
        -------------------------------------------- */
        if (openNewTabBtn) {
          openNewTabBtn.addEventListener("click", () => {
            // src looks like: /scramjet/https://vidfast.pro/movie/123
            let direct = src.replace("/scramjet/", "");
            window.open(direct, "_blank");
          });
        }

        /* -------------------------------------------
           BAREMUX INIT
        -------------------------------------------- */
        try {
          const connection = new BareMux.BareMuxConnection("/baremux/worker.js");
          const wispUrl =
            (location.protocol === "https:" ? "wss" : "ws") +
            "://" +
            location.host +
            "/wisp/";

          if ((await connection.getTransport()) !== "/epoxy/index.mjs") {
            await connection.setTransport("/epoxy/index.mjs", [{ wisp: wispUrl }]);
          }
          console.log("BareMux transport ready in mediaplayer tab");
        } catch (err) {
          console.error("Failed to init BareMux transport (mediaplayer)", err);
          if (loadingSub) {
            loadingSub.textContent =
              "Proxy transport failed to init. The page may still load, but some hosts will break.";
          }
        }

        /* -------------------------------------------
           TIMEOUTS
        -------------------------------------------- */
        let longTimeout = setTimeout(() => {
          if (loadingSub) {
            loadingSub.textContent =
              "This is taking longer than usual. The media host or proxy might be slow or timing out.";
          }
        }, 8000);

        let hardTimeout = setTimeout(() => {
          if (loadingEl) loadingEl.style.display = "none";
          if (errorEl) {
            errorEl.style.display = "flex";
            errorEl.textContent =
              "The media did not finish loading. It may be blocked, down, or the proxy hit a timeout.";
          }
        }, 25000);

        /* -------------------------------------------
           LOAD IFRAME
        -------------------------------------------- */
        if (frame) {
          frame.addEventListener("load", () => {
            if (loadingEl) loadingEl.style.display = "none";
            clearTimeout(longTimeout);
            clearTimeout(hardTimeout);
          });

          frame.src = src;
        }
      })();
    </script>
  </body>
</html>
