<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S0LACE â€¢ Stats</title>

  <link rel="shortcut icon" href="favicon.ico" />
  <link rel="stylesheet" href="index.css" />
  <script src="global-hub.js" defer></script>
  <script src="register-sw.js" defer></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8373843490344171"
     crossorigin="anonymous"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    main {
      padding: 40px 24px;
      max-width: 900px;
      margin: 0 auto;
    }

    .stats-title {
      font-family: "Press Start 2P";
      font-size: 12px;
      margin: 28px 0 12px;
      color: var(--fg);
    }

    .stats-section {
      margin-bottom: 40px;
    }

    .geo-list {
      margin-top: 12px;
      border-top: 1px solid #222;
    }

    .geo-item {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 12px;
      color: var(--fg-dim);
    }

    canvas {
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      padding: 8px;
    }
  </style>
</head>

<body>

<!-- SIDE NAV -->
<nav class="side-header">
  <a href="index.html" class="side-icon" data-icon="home"><img /></a>
  <a href="games.html" class="side-icon" data-icon="games"><img /></a>
  <a href="media.html" class="side-icon" data-icon="media"><img /></a>
  <a href="settings.html" class="side-icon" data-icon="settings"><img /></a>
</nav>

<main>

  <h1 class="stats-title">VISITOR STATS</h1>

  <div class="stats-section">
    <div class="stats-title">TOP COUNTRIES</div>
    <canvas id="countriesChart" height="140"></canvas>
    <div class="geo-list" id="geo-countries"></div>
  </div>

  <div class="stats-section">
    <div class="stats-title">TOP REGIONS</div>
    <canvas id="regionsChart" height="140"></canvas>
    <div class="geo-list" id="geo-regions"></div>
  </div>

</main>

<!-- SIDE ICON SYNC -->
<script>
function getAccent() {
  return localStorage.getItem("s0laceAccent") || "gray";
}

function updateSideIcons() {
  const accent = getAccent();
  document.querySelectorAll(".side-icon").forEach(link => {
    const icon = link.dataset.icon;
    const img = link.querySelector("img");
    const active = location.pathname.endsWith(link.getAttribute("href"));
    link.classList.toggle("active", active);
    img.src = `thumbs/${icon}/${active ? accent : "gray"}.png`;
  });
}

updateSideIcons();
window.addEventListener("storage", updateSideIcons);
</script>

<!-- FIREBASE GEO STATS -->
<script type="module">
import { initializeApp, getApps } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, get } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const config = {
  apiKey: "AIzaSyBbgy76ThxHaKlOhpiLQ6Nw4ekR1b9t3DA",
  databaseURL: "https://s0lace-web-default-rtdb.firebaseio.com",
  projectId: "s0lace-web"
};

const app = getApps().length ? getApps()[0] : initializeApp(config);
const db = getDatabase(app);

function renderGeo(data, listEl, canvasId) {
  const entries = Object.entries(data || {})
    .sort((a,b) => b[1] - a[1])
    .slice(0, 8);

  listEl.innerHTML = "";

  entries.forEach(([name,count]) => {
    const row = document.createElement("div");
    row.className = "geo-item";
    row.innerHTML = `<span>${name}</span><span>${count}</span>`;
    listEl.appendChild(row);
  });

  new Chart(document.getElementById(canvasId), {
    type: "bar",
    data: {
      labels: entries.map(e => e[0]),
      datasets: [{
        data: entries.map(e => e[1]),
        backgroundColor: "rgba(120,160,255,0.6)"
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: "#aaa" } },
        y: { ticks: { color: "#aaa" } }
      }
    }
  });
}

async function loadStats() {
  const [countriesSnap, regionsSnap] = await Promise.all([
    get(ref(db,"geo/countries")),
    get(ref(db,"geo/regions"))
  ]);

  if (countriesSnap.exists()) {
    renderGeo(
      countriesSnap.val(),
      document.getElementById("geo-countries"),
      "countriesChart"
    );
  }

  if (regionsSnap.exists()) {
    renderGeo(
      regionsSnap.val(),
      document.getElementById("geo-regions"),
      "regionsChart"
    );
  }
}

loadStats();
</script>

</body>
</html>
